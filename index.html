<html>
<head>
<link rel="stylesheet" href="https://jonudell.info/hlib/hlib.css">
<style>
@import url(https://fonts.googleapis.com/css?family=Raleway:500,400,300,800,700);

body {
	font-family: Raleway;
  font-size: 16px;
	word-break: break-word; 
}

.urlForm input {
  width: 600px;
}

</style>
<script src="https://jonudell.info/hlib/showdown.js"></script>
<script src="https://jonudell.info/hlib/hlib.js"></script>
</head>
<body>

<div class="formContainer">
  <div class="formField" id="urlContainer"></div>
  <div class="formField">
    sort by
    <input type="radio" checked value="location" name="sort">location</input>
    <input type="radio" value="newest" name="sort">newest</input>
  </div>
  <div>
    <button onclick="search()">search</button> 
  </div>
</div>

<div>
  <h1>Annotations</h1>
  <div id="annotations"></div>
</div>  

<div>
  <h1>Pagenotes</h1>
  <div id="pagenotes"></div>
</div>

<script>

function stripWhitespace(text) {
  text = text.replace(/\s+/g, ' ');
  return text;
}

function escape(html) {
  return html.replace(/</g, '&lt;')
}

function reformat(anno) {
  var elt = document.createElement('div');
  elt.innerHTML = anno;
  elt.querySelector('.annotationTags').remove();

  var quoteHTML;
  var quote = elt.querySelector('.annotationQuote');
  if (quote) {
    quoteHTML = stripWhitespace(quote.innerHTML);
    quote.remove();
  }
  var quoteOutput = '';
  if (quoteHTML) {
    quoteOutput = escape(`<blockquote><em>${quoteHTML}</em></blockquote>`);
  }

  var comment = elt.querySelector('.annotationBody div');
  var commentHTML = stripWhitespace(comment.innerHTML);

  var user = anno.match(/\?user=(.+)"/)[1];

  var output = `
${quoteOutput}
[quote_sci user="${user}"]
${escape(commentHTML)}
`;

  return output;
}

function compareLocation(a,b) {
  var aStart = parseSelectors(a.target).TextPosition.start;
  var bStart = parseSelectors(b.target).TextPosition.start;
  if (aStart < bStart) {
    return -1;
  }
  if (aStart > bStart) {
    return 1;
  }
  return 0;
}

function compareDate(a,b) {
  if (a.updated < b.updated) {
    return -1;
  }
  if (a.updated > b.updated) {
    return 1;
  }
  return 0;
}

function formatAnnotationAndReplies(annotation, replies) {
  var _replies = findRepliesForId(annotation.id, replies);
  var all = [annotation].concat(_replies);
  var output = '';
  all.forEach ( anno => {
     var level = 0;
     if (anno.refs) {
       level = anno.refs.length;
     }
     output += reformat(showAnnotation(anno, 0));
    });
  output = `
&lt;section>
${output}
&lt;/section>

`;
  return output;
}

function singleNewlines(text) {
  text = text.replace(/[\n\r]+/g, '\n');
  return text;
}

function finalize(text) {
  text = singleNewlines(text);
  text = text.replace(/&lt;\/section>/g, '&lt;/section>\n');
  return text;
}

function processSearchResults(annos, replies) {
  annos = annos.map(a => parseAnnotation(a) );
  var sortKey = document.querySelector('input[name=sort]:checked').value;
  var sortFn = sortKey === 'location' ? compareLocation : compareDate;

  var annotations = annos.filter(x => ! x.isPagenote);
  annotations.sort(sortFn).reverse();
  var annotationOutput = '';
  annotations.forEach(annotation => {
    annotationOutput += formatAnnotationAndReplies(annotation, replies);
  });
  getById('annotations').innerHTML = '<pre>' + finalize(annotationOutput) + '</pre>';

  var pagenotes = annos.filter(x => x.isPagenote);
  pagenotes.sort(compareDate);
  var pagenoteOutput = ''
  pagenotes.forEach(pagenote => {
    pagenoteOutput += formatAnnotationAndReplies(pagenote, replies);
  });
  getById('pagenotes').innerHTML = '<pre>' + finalize(pagenoteOutput) + '</pre>';
}

function search() {
  var url = getFromUrlParamOrLocalStorage('h_url');
  
  var params = { 
    url: url,
    group: '__world__',   // update when CF migrates to its own group
  }

  getById('annotations').innerHTML = '';
  getById('pagenotes').innerHTML = '';

  hApiSearch(params, processSearchResults);
}

function setUrl() {
  setLocalStorageFromForm('urlForm', 'h_url');
}

function getUrl() {
  return getFromUrlParamOrLocalStorage('h_url', '')
}  
createNamedInputForm(getById('urlContainer'), 
                      'URL', 
                      'url', 
                      getUrl(),
                      'setUrl',
                      '', 
                      'URL from which to export annotations'
                    );
                    
  if (gup('h_url') !== '') {
    document.querySelector(`.urlForm input`).value = gup('h_url');
}
</script>

</body>
</html>